<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libsidplayfp: reSIDfp::Integrator Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libsidplayfp
   &#160;<span id="projectnumber">2.1.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><b>reSIDfp</b></li><li class="navelem"><a class="el" href="classreSIDfp_1_1Integrator.html">Integrator</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classreSIDfp_1_1Integrator-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">reSIDfp::Integrator Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="Integrator_8h_source.html">Integrator.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a18a3bf2cb6081826874a99a34c936850"><td class="memItemLeft" align="right" valign="top"><a id="a18a3bf2cb6081826874a99a34c936850"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>Integrator</b> (const unsigned short *vcr_Vg, const unsigned short *vcr_n_Ids_term, const unsigned short *opamp_rev, unsigned short Vddt, unsigned short nVt, unsigned short nVmin, unsigned short n_snake, double N16)</td></tr>
<tr class="separator:a18a3bf2cb6081826874a99a34c936850"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae433c9ec30455e9fe0f20c02035a1417"><td class="memItemLeft" align="right" valign="top"><a id="ae433c9ec30455e9fe0f20c02035a1417"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>setVw</b> (unsigned short Vw)</td></tr>
<tr class="separator:ae433c9ec30455e9fe0f20c02035a1417"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a70d1f07745b34502a931098fa3e3aa3a"><td class="memItemLeft" align="right" valign="top"><a id="a70d1f07745b34502a931098fa3e3aa3a"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><b>solve</b> (int vi) const</td></tr>
<tr class="separator:a70d1f07745b34502a931098fa3e3aa3a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Find output voltage in inverting integrator <a class="el" href="classreSIDfp_1_1SID.html">SID</a> op-amp circuits, using a single fixpoint iteration step.</p>
<p>A circuit diagram of a MOS 6581 integrator is shown below. </p><pre class="fragment">              +---C---+
              |       |
vi --o--Rw--o-o--[A&gt;--o-- vo
     |      | vx
     +--Rs--+
</pre><p>From Kirchoff's current law it follows that </p><pre class="fragment">IRw + IRs + ICr = 0
</pre><p>Using the formula for current through a capacitor, i = C*dv/dt, we get </p><pre class="fragment">IRw + IRs + C*(vc - vc0)/dt = 0
dt/C*(IRw + IRs) + vc - vc0 = 0
vc = vc0 - n*(IRw(vi,vx) + IRs(vi,vx))
</pre><p>which may be rewritten as the following iterative fixpoint function: </p><pre class="fragment">vc = vc0 - n*(IRw(vi,g(vc)) + IRs(vi,g(vc)))
</pre><p>To accurately calculate the currents through Rs and Rw, we need to use transistor models. Rs has a gate voltage of Vdd = 12V, and can be assumed to always be in triode mode. For Rw, the situation is rather more complex, as it turns out that this transistor will operate in both subthreshold, triode, and saturation modes.</p>
<p>The Shichman-Hodges transistor model routinely used in textbooks may be written as follows: </p><pre class="fragment">Ids = 0                          , Vgst &lt; 0               (subthreshold mode)
Ids = K*W/L*(2*Vgst - Vds)*Vds   , Vgst &gt;= 0, Vds &lt; Vgst  (triode mode)
Ids = K*W/L*Vgst^2               , Vgst &gt;= 0, Vds &gt;= Vgst (saturation mode)
</pre><p>where K = u*Cox/2 (transconductance coefficient) W/L = ratio between substrate width and length Vgst = Vg - Vs - Vt (overdrive voltage)</p>
<p>This transistor model is also called the quadratic model.</p>
<p>Note that the equation for the triode mode can be reformulated as independent terms depending on Vgs and Vgd, respectively, by the following substitution: </p><pre class="fragment">Vds = Vgst - (Vgst - Vds) = Vgst - Vgdt

Ids = K*W/L*(2*Vgst - Vds)*Vds
    = K*W/L*(2*Vgst - (Vgst - Vgdt)*(Vgst - Vgdt)
    = K*W/L*(Vgst + Vgdt)*(Vgst - Vgdt)
    = K*W/L*(Vgst^2 - Vgdt^2)
</pre><p>This turns out to be a general equation which covers both the triode and saturation modes (where the second term is 0 in saturation mode). The equation is also symmetrical, i.e. it can calculate negative currents without any change of parameters (since the terms for drain and source are identical except for the sign).</p>
<p>FIXME: Subthreshold as function of Vgs, Vgd. </p><pre class="fragment">Ids = I0*W/L*e^(Vgst/(Ut/k))   , Vgst &lt; 0               (subthreshold mode)
</pre><p>where I0 = (2 * uCox * Ut^2) / k</p>
<p>The remaining problem with the textbook model is that the transition from subthreshold the triode/saturation is not continuous.</p>
<p>Realizing that the subthreshold and triode/saturation modes may both be defined by independent (and equal) terms of Vgs and Vds, respectively, the corresponding terms can be blended into (equal) continuous functions suitable for table lookup.</p>
<p>The EKV model (Enz, Krummenacher and Vittoz) essentially performs this blending using an elegant mathematical formulation: </p><pre class="fragment">Ids = Is * (if - ir)
Is = ((2 * u*Cox * Ut^2)/k) * W/L
if = ln^2(1 + e^((k*(Vg - Vt) - Vs)/(2*Ut))
ir = ln^2(1 + e^((k*(Vg - Vt) - Vd)/(2*Ut))
</pre><p>For our purposes, the EKV model preserves two important properties discussed above:</p>
<ul>
<li>It consists of two independent terms, which can be represented by the same lookup table.</li>
<li>It is symmetrical, i.e. it calculates current in both directions, facilitating a branch-free implementation.</li>
</ul>
<p>Rw in the circuit diagram above is a VCR (voltage controlled resistor), as shown in the circuit diagram below.</p>
<pre class="fragment">                   Vdd
                      |
         Vdd         _|_
            |    +---+ +---- Vw
           _|_   |
        +--+ +---o Vg
        |      __|__
        |      -----  Rw
        |      |   |
vi -----o------+   +-------- vo
</pre><p>In order to calculalate the current through the VCR, its gate voltage must be determined.</p>
<p>Assuming triode mode and applying Kirchoff's current law, we get the following equation for Vg: </p><pre class="fragment">u*Cox/2*W/L*((Vddt - Vg)^2 - (Vddt - vi)^2 + (Vddt - Vg)^2 - (Vddt - Vw)^2) = 0
2*(Vddt - Vg)^2 - (Vddt - vi)^2 - (Vddt - Vw)^2 = 0
(Vddt - Vg) = sqrt(((Vddt - vi)^2 + (Vddt - Vw)^2)/2)

Vg = Vddt - sqrt(((Vddt - vi)^2 + (Vddt - Vw)^2)/2)
</pre> </div><hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="Integrator_8h_source.html">Integrator.h</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Apr 19 2021 18:39:44 for libsidplayfp by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
